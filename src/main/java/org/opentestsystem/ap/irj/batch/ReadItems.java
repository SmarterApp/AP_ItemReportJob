package org.opentestsystem.ap.irj.batch;

import java.util.List;

import org.opentestsystem.ap.irj.service.ItemReportJobService;
import org.springframework.batch.item.ItemReader;
import org.springframework.batch.item.NonTransientResourceException;
import org.springframework.batch.item.ParseException;
import org.springframework.batch.item.UnexpectedInputException;

public class ReadItems implements ItemReader<String> {

    private int count;

    private List<String> itemIds;

    private final ItemReportJobService itemReportJobService;

    public ReadItems(final ItemReportJobService itemReportJobService) {
        this.itemReportJobService = itemReportJobService;
        count = 0;
    }

    @Override
    public String read() throws Exception, UnexpectedInputException,
        ParseException, NonTransientResourceException {

        if (itemIdsNotInitialized()) {
            itemIds = initialize();
        }

        String id = null;
        if (count < itemIds.size()) {
            id = itemIds.get(count++);
        } else {
            itemIds = null;
            count = 0;
        }
        return id;
    }

    private boolean itemIdsNotInitialized() {
        return this.itemIds == null;
    }

    public List<String> initialize() {
        return itemReportJobService.findAllItemNames();
    }
}
