package org.opentestsystem.ap.irj.repository;

import java.nio.file.Path;

import com.google.common.annotations.VisibleForTesting;
import lombok.extern.slf4j.Slf4j;
import org.gitlab4j.api.models.Project;
import org.opentestsystem.ap.common.client.GitClient;
import org.opentestsystem.ap.common.client.GitClientFactory;
import org.opentestsystem.ap.common.client.GitlabClient;
import org.opentestsystem.ap.common.config.ItemBankProperties;
import org.opentestsystem.ap.common.exception.ResourceNotFoundException;
import org.opentestsystem.ap.common.model.ItemBankSystemUser;
import org.opentestsystem.ap.common.model.ItemBankUser;
import org.opentestsystem.ap.common.repository.RepositoryDependencyProvider;
import org.springframework.stereotype.Component;

import static org.opentestsystem.ap.common.repository.RepositoryUtil.deleteDirectory;
import static org.opentestsystem.ap.common.repository.RepositoryUtil.generateLocalRepoPath;

/**
 * Handles operations associated with the report repository.
 */
@Slf4j
@Component
public class ReportRepository {

    private static final String REPORT_LOCK = "report";

    private final GitClientFactory gitClientFactory;

    private final GitlabClient gitlabClient;


    private final ItemBankProperties itemBankProperties;

    private final String reportRepoName;

    private Project reportRepoProject;

    public ReportRepository(final RepositoryDependencyProvider repositoryDependencyProvider) {
        this.gitClientFactory = repositoryDependencyProvider.getGitClientFactory();
        this.gitlabClient = repositoryDependencyProvider.getGitlabClient();
        this.itemBankProperties = repositoryDependencyProvider.getItemBankProperties();
        this.reportRepoName = itemBankProperties.getReportRepoName();
    }

    // ------------------------------------------------------------------------

    public Path initialize(final ItemBankSystemUser user) {
        final Path path;
        reportRepoProject = lookupReportRepoProject();
        if (reportRepoProject == null) {
            deleteLocalReportRepo();
            reportRepoProject = createReportProject();
            path = initializeReportRepository(user);
        } else {
            path = attachToReportRepository(user);
        }
        return path;
    }

    public void publishReport(final ItemBankSystemUser user, final String reportFile, final String summaryFile) {
        final GitClient git = gitClientFactory.openRepository(user, reportRepoName);
        git.stageFiles(reportFile);
        git.stageFiles(summaryFile);
        git.commit("Publishing new report");
        git.push();
    }

    public boolean lockReportRepo(final ItemBankUser user) {
        log.debug("lockReportRepo: lock name '{}'", REPORT_LOCK);
        return gitlabClient.lockSection(user, reportRepoProject, REPORT_LOCK);
    }

    public void unlockReportRepo(final ItemBankUser user) {
        log.debug("unlockReportRepo: lock name '{}'", REPORT_LOCK);
        gitlabClient.deleteSectionLock(reportRepoProject, REPORT_LOCK);
    }

    // ------------------------------------------------------------------------

    @VisibleForTesting
    Project createReportProject() {
        log.debug("createReportProject: name {}", reportRepoName);
        final Project project = gitlabClient.createProject(reportRepoName);
        return project;
    }

    @VisibleForTesting
    Path initializeReportRepository(final ItemBankSystemUser user) {
        final GitClient git = gitClientFactory.cloneRemoteRepository(user, reportRepoName);
        git.createRepository("Creating report repository.");
        return git.getLocalRepositoryPath();
    }

    @VisibleForTesting
    Path attachToReportRepository(final ItemBankSystemUser user) {
        final GitClient git = gitClientFactory.openRepository(user, reportRepoName);
        return git.getLocalRepositoryPath();
    }

    @VisibleForTesting
    Project lookupReportRepoProject() {
        log.debug("lookupReportProject: name {}", reportRepoName);
        Project project = null;
        try {
            project = gitlabClient.lookupProjectByName(reportRepoName);
        } catch (ResourceNotFoundException e) {

        }
        return project;
    }

    @VisibleForTesting
    void deleteLocalReportRepo() {
        final Path localRepoPath = generateLocalRepoPath(itemBankProperties.getLocalBaseDir(), reportRepoName);
        deleteDirectory(localRepoPath);
    }
}


